---
title: "新冠状病毒报告"
author: "WY"
date: "2/4/2020"
output:
  github_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 每日冠状病毒传染数据

数据来源是一个R数据包。. 可以用下面的命令安装该数据包

```{r eval=FALSE}
remotes::install_github("GuangchuangYu/nCov2019")
```

首先加载一些功能包和数据：
```{r loading libraries and data, message=FALSE, warning=FALSE}
library(nCov2019)
library(utf8)
library(tidyverse)
library(lubridate)
library(showtext)
font_add("heiti", "simhei.ttf")
font_add("constan", regular = "constan.ttf", italic = "constani.ttf")
showtext_auto()
x <- get_nCov2019()
```

下面的命令用来整理数据：
```{r data cleaning,}
dataDay <- x$chinaDayList %>% mutate(confirm = as.numeric(confirm), suspect = as.numeric(suspect), dead = as.numeric(dead), heal = as.numeric(heal), deathoverconfirm = dead/confirm)
dataDay <- dataDay %>% extract(date,c("month","day"), regex = "^(\\d+)\\.(\\d+)$",remove = FALSE) 
dataDay <- dataDay %>% mutate(month = as.numeric(month), day = as.numeric(day))
dataDay <- dataDay %>% mutate(date = make_date(2020,month,day))

dataAdd <- x$chinaDayAddList %>% mutate(confirm = as.numeric(confirm), suspect = as.numeric(suspect), dead = as.numeric(dead), heal = as.numeric(heal), deathoverconfirm = dead/confirm)
dataAdd <- dataAdd %>% extract(date,c("month","day"), regex = "^(\\d+)\\.(\\d+)$",remove = FALSE) 
dataAdd <- dataAdd %>% mutate(month = as.numeric(month), day = as.numeric(day))
dataAdd <- dataAdd %>% mutate(date = make_date(2020,month,day))

```

该数据的更新时间是（北京时间）：
```{r}
x$lastUpdateTime
```


确诊和疑似病例的数据如下：

```{r, fig.showtext=TRUE}
showtext_auto()
dataDay %>% ggplot() + geom_point(aes(date,confirm,colour=as_utf8("确诊"))) +geom_point(aes(date,suspect,color="疑似")) +theme(legend.position="right")+ylab("病例数")+xlab("日期")+labs(colour="类别")+scale_color_manual(values=c("blue","red"))
```

确认病理+疑似病例的变化如下：

1月28日到2月9日之间，该数据成直线上涨趋势。

```{r}
dataDay <- dataDay %>% mutate(confandsusp = confirm + suspect)
dataforfitting <- dataDay %>% filter(date > make_date(2020,1,27) & date < make_date(2020,2,9)) 
model <- lm(confandsusp ~ date, data=dataforfitting)
plot(dataDay$date, dataDay$confandsusp, xlab = as_utf8("日期"), ylab = "confirmed + suspected" )
abline(model)
mtext(paste("The number of cases (suspected + confirmed) increases", as.character(floor(model$coefficients[2])),"per day on average after Jan 28th.\n with R-squared value of ",round(summary(model)$r.squared, digits=5),"."))
```


Now, we want to calculate the rate of death. There are several ways to do this, one way is to divide the dead by the confirmed cases.

```{r}
dataDay %>% ggplot(aes(date,deathoverconfirm))+geom_point()
```

Another way of calculation is to use dead and recovered as total number of cases that we know the results. Then we could find the portion of cases result in death.

```{r}
dataDay %>% ggplot()+geom_point(aes(date,dead/(heal+dead)))
```

Here are the total dead and healed cases:

```{r}
dataDay %>% ggplot() + geom_point(aes(date,dead,colour="Dead")) +geom_point(aes(date,heal,color="Healed")) +theme(legend.position="right")+ylab("Number of cases")+labs(colour="Type")+scale_color_manual(values=c("black","red"))
```


Now we present the new cases on each day:

```{r}
dataAdd %>% ggplot() + geom_point(aes(date,confirm,colour="Confirmed")) +geom_point(aes(date,suspect,color="Suspect")) +theme(legend.position="right")+ylab("Number of cases")+labs(colour="Type")+scale_color_manual(values=c("blue","red"))
```

And the sum of newly confimred and suspected cases for each day:

```{r}
dataAdd %>% ggplot(aes(date,confirm+suspect))+geom_point()
```

Here are daily numbers of death and recovery:

```{r}
dataAdd %>% ggplot() + geom_point(aes(date,dead,colour="Dead")) +geom_point(aes(date,heal,color="Healed")) +theme(legend.position="right")+ylab("Number of cases")+labs(colour="Type")+scale_color_manual(values=c("black","red"))
```


## Cases by country

We just look at the total number of cases for countries:
```{r, message=FALSE, fig.height=8}
library(grid)
library(gridExtra)
areatotal <- x$are$total %>% select(confirm, suspect, dead, heal,deadRate,healRate)
areatotal <- cbind(x$areaTree$name,areatotal)
names(areatotal)[1] <- "Country"
grid.table(areatotal)
```

## Cases by Chinese provinces

The death rate for Hubei province and non-Hubei province is provided.

```{r}
deathrate<-x$dailyDeadRateHistory
deathrate <- deathrate %>% mutate(hubeiRate=as.numeric(hubeiRate), notHubeiRate=as.numeric(notHubeiRate), countryRate=as.numeric(countryRate))
deathrate <- deathrate %>% extract(date,c("month","day"), regex = "^(\\d+)\\.(\\d+)$",remove = FALSE) 
deathrate <- deathrate %>% mutate(month = as.numeric(month), day = as.numeric(day))
deathrate <- deathrate %>% mutate(date = make_date(2020,month,day))
deathrate %>% ggplot()+geom_point(aes(date,hubeiRate,color="Hubei Rate"))+geom_point(aes(date,notHubeiRate,color="non-Hubei Rate"))+geom_point(aes(date,countryRate,color="country Rate"))+ ylab("Percentage(%)")
```


```{r,fig.height=8,fig.width=6}
mytheme <- gridExtra::ttheme_default(core = list(fg_params=list(cex = 1.0)),colhead = list(fg_params=list(cex = 1.0)),rowhead = list(fg_params=list(cex = 1.0)))
deathrate<-x$dailyDeadRateHistory
names(deathrate) <- c("Date","hubei\nDead","hubei\nConfirm","country\nDead","country\nConfirm","hubei\nRate","notHubei\nRate","country\nRate")
grid.table(deathrate,theme=mytheme)

```

Detailed information for each province:

```{r,  warning=FALSE}
y <- load_nCov2019()

```

```{r,fig.height=5}
for(i in 1:34)
{
  grid.text(label = as.character(x[,1]$name[i]),x=0.5,y=.9, gp=gpar(cex=2))
  if(dim(x[i])[1]<10){
  grid.table(x[i] %>% select(name,confirm,dead,heal,deadRate,healRate),vp=viewport(x=0.5,y=.5,width=1,height=1))
  grid.newpage()
  }
  if(dim(x[i])[1]>=10){
  grid.table(x[i] %>% head(10) %>% select(name,confirm,dead,heal,deadRate,healRate),vp=viewport(x=0.5,y=.5,width=1,height=1))
  grid.newpage()
  }
  provs <- as.character(x[,1]$name[i])
  
    if(y$data %>% filter(province==provs) %>% .$city %>% as.factor %>% levels %>% length != 1){
p <- y$data %>% filter(province==provs,city!=provs) %>% group_by(city) %>% ggplot(color=city) + geom_line(aes(time,cum_confirm,color=city))+geom_point(aes(time,cum_confirm,color=city))+ylab(paste(provs," confirmed"))
print(p)
grid.newpage()
    }
  
      if(y$data %>% filter(province==provs) %>% .$city %>% as.factor %>% levels %>% length == 1){
p <- y$data %>% filter(province==provs)%>% ggplot(color=city) + geom_line(aes(time,cum_confirm,color=city))+geom_point(aes(time,cum_confirm,color=city))+ylab(paste(provs," confirmed"))
print(p)
grid.newpage()
    }
  
}
```


